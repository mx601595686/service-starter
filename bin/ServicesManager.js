"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Log_1 = require("./Log");
const events = require("events");
const ServiceModule_1 = require("./ServiceModule");
const http = require("http");
const fs = require("fs-extra");
/**
 * 保存注册了的服务
 *
 * @class _Services
 */
class _Services {
    constructor(service) {
        /**
         * 服务是否已启动
         *
         * @type {boolean}
         * @memberof _Services
         */
        this.isStarted = false;
        this.service = service;
        this.name = service.name;
    }
}
exports._Services = _Services;
class ServicesManager extends events.EventEmitter {
    constructor(config = {}) {
        super();
        this._isStarted = false; //是否已经启动
        /**
         * 注册的服务。(服务只应当通过registerService来进行注册)
         */
        this._services = [];
        if (ServicesManager._servicesManagerCreated)
            throw new Error('ServicesManager已经被创建了');
        ServicesManager._servicesManagerCreated = true;
        process.on('unhandledRejection', (err) => {
            Log_1.log.e('程序出现未捕捉Promise异常：', err);
            if (config.stopOnHaveUnhandledRejection !== false) {
                this.stop(1);
            }
        });
        process.on('uncaughtException', (err) => {
            Log_1.log.e('程序出现未捕捉异常：', err);
            if (config.stopOnHaveUncaughtException !== false) {
                this.stop(1);
            }
        });
        process.on('SIGTERM', () => {
            if (config.stopOnHaveSIGTERM !== false) {
                this.stop();
            }
        });
        process.on('SIGINT', () => {
            if (config.stopOnHaveSIGINT !== false) {
                this.stop();
            }
        });
        //配置健康检查服务
        if (config.startHealthChecking !== false) {
            //删除之前的接口，避免被占用
            fs.removeSync("/tmp/node_service_starter/health_checking.sock");
            http.createServer(async (req, res) => {
                //log.l('接收到健康检查请求');
                let result = ServiceModule_1.HealthStatus.success;
                //检查每一个服务的健康状况
                for (let item of this._services) {
                    //跳过未启动的服务
                    if (!item.isStarted)
                        continue;
                    try {
                        const status = await item.service.onHealthChecking();
                        if (status != ServiceModule_1.HealthStatus.success) {
                            Log_1.log.w(item.name, '的运行健康状况出现不正常：', status);
                            result = status;
                            break;
                        }
                    }
                    catch (error) {
                        Log_1.log.e(item.name, '在进行健康检查时发生异常', error);
                        break;
                    }
                }
                res.end(result.toString());
            }).listen("/tmp/node_service_starter/health_checking.sock", (err) => {
                if (err) {
                    Log_1.log.e('健康检查服务启动失败：', err);
                    process.exit(1);
                }
            });
        }
    }
    /**
     * 启动所有注册的服务。按照注册的先后顺序来启动服务。先注册的服务先启动。
     * 如果启动过程中某个服务出现异常，则后面的服务则不再被启动，之前启动过了的服务也会被依次关闭（按照从后向前的顺序）。
     * 启动结束后会触发started事件
     *
     * @memberof ServicesManager
     */
    start() {
        if (this._isStarted === false) {
            Log_1.log.l(this.constructor.name, '开始启动服务');
            this._isStarted = true;
            (async () => {
                for (let item of this._services) {
                    if (item.isStarted === false) {
                        try {
                            Log_1.log.starting('开始启动服务', item.name);
                            item.isStarted = true;
                            await item.service.onStart();
                            //绑定错误处理器
                            item.service.on('error', item.errorListener);
                            Log_1.log.started('服务启动成功', item.name);
                        }
                        catch (error) {
                            Log_1.log.startFailed('服务启动失败', item.name, error);
                            this.stop();
                            return;
                        }
                    }
                }
                Log_1.log.l('所有服务已启动');
                this.emit('started');
            })();
        }
    }
    /**
     * 关闭所有已启动的服务。先注册的服务最后被关闭。当所有服务都被关闭后程序将会被退出。
     * 当所有服务都停止后出发stopped事件
     *
     * @param exitCode 程序退出状态码。 1是未捕捉的系统错误 2是用户ServiceModule的onError发出的‘stop’信号
     */
    stop(exitCode = 0) {
        if (this._isStarted === true) {
            Log_1.log.l(this.constructor.name, '开始停止服务');
            this._isStarted = false;
            (async () => {
                for (let item of this._services.reverse()) {
                    if (item.isStarted) {
                        try {
                            Log_1.log.stopping('开始停止服务', item.name);
                            item.isStarted = false;
                            await item.service.onStop();
                            //清除绑定的错误监听器
                            item.service.removeListener('error', item.errorListener);
                            Log_1.log.stopped('服务启动成功', item.name);
                        }
                        catch (error) {
                            Log_1.log.stopFailed('服务停止失败', item.name, error);
                        }
                    }
                }
                Log_1.log.l('所有服务已停止');
                this.emit('stopped');
                //退出服务
                process.exit(exitCode);
            })();
        }
    }
    /**
     * 注册服务
     *
     * @param {ServiceModule} serviceModule 服务模块实例
     * @memberof ServicesManager
     */
    registerService(serviceModule) {
        if (this._services.some(item => item.name == serviceModule.name)) {
            throw new Error(`服务'${serviceModule.name}'已注册过了`);
        }
        else {
            const service = new _Services(serviceModule);
            //创建服务运行时错误监听器
            service.errorListener = (err) => {
                const value = service.service.onError(err);
                switch (value) {
                    case false:
                        this.onError(err, serviceModule);
                        break;
                    case true:
                        break;
                    case 'stop':
                        this.onError(err, serviceModule);
                        this.stop(2);
                        break;
                    default:
                        if (value instanceof Error)
                            this.onError(value, serviceModule);
                        break;
                }
            };
            this._services.push(service);
        }
    }
    /**
     * 服务运行过程中的错误处理方法。服务启动或关闭过程中产生的错误不会触发该方法。
     *
     * @param {Error} err
     * @param {ServiceModule} service 发生错误的服务实例
     * @memberof ServicesManager
     */
    onError(err, service) {
        Log_1.log.e(service.name, '发生错误：', err);
    }
}
ServicesManager._servicesManagerCreated = false; //ServicesManager是否已经创建了（一个进程只允许创建一个ServicesManager）
exports.ServicesManager = ServicesManager;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RztJQUNILE9BQU8sQ0FBQyxHQUFVLEVBQUUsT0FBc0I7UUFDdEMsU0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN0QyxDQUFDOztBQXhNYyx1Q0FBdUIsR0FBRyxLQUFLLENBQUMsQ0FBQyxvREFBb0Q7QUFIeEcsMENBNE1DIiwiZmlsZSI6IlNlcnZpY2VzTWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxvZyB9IGZyb20gJy4vTG9nJztcbmltcG9ydCBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKTtcbmltcG9ydCB7IFNlcnZpY2VNb2R1bGUsIEhlYWx0aFN0YXR1cyB9IGZyb20gXCIuL1NlcnZpY2VNb2R1bGVcIjtcbmltcG9ydCBodHRwID0gcmVxdWlyZSgnaHR0cCcpO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcblxuLyoqXG4gKiBTZXJ2aWNlc01hbmFnZXLphY3nva5cbiAqIFxuICogQGV4cG9ydFxuICogQGludGVyZmFjZSBTZXJ2aWNlc01hbmFnZXJDb25maWdcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZXJ2aWNlc01hbmFnZXJDb25maWcge1xuICAgIC8qKlxuICAgICAqIOW9k+acieacquaNleiOt+W8guW4uOeahFByb21pc2XkuqfnlJ/ml7bmmK/lkKblgZzmraLmnI3liqEo6buY6K6kdHJ1ZSzlgZzmraIpXG4gICAgICogXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICogQG1lbWJlcm9mIFNlcnZpY2VzTWFuYWdlckNvbmZpZ1xuICAgICAqL1xuICAgIHN0b3BPbkhhdmVVbmhhbmRsZWRSZWplY3Rpb24/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICog5b2T5pyJ5pyq5o2V6I635byC5bi45Lqn55Sf5pe25piv5ZCm5YGc5q2i5pyN5YqhKOm7mOiupHRydWUs5YGc5q2iKVxuICAgICAqIFxuICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAqIEBtZW1iZXJvZiBTZXJ2aWNlc01hbmFnZXJDb25maWdcbiAgICAgKi9cbiAgICBzdG9wT25IYXZlVW5jYXVnaHRFeGNlcHRpb24/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgICog5b2T5pS25YiwU0lHVEVSTeS/oeWPt+aXtuaYr+WQpuWBnOatouacjeWKoSjpu5jorqR0cnVlLOWBnOatoilcbiAgICAgKiBcbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKiBAbWVtYmVyb2YgU2VydmljZXNNYW5hZ2VyQ29uZmlnXG4gICAgICovXG4gICAgc3RvcE9uSGF2ZVNJR1RFUk0/OiBib29sZWFuO1xuXG4gICAgLyoqXG4gICAgKiDlvZPmlLbliLBTSUdJTlTkv6Hlj7fml7bmmK/lkKblgZzmraLmnI3liqEo6buY6K6kdHJ1ZSzlgZzmraIpXG4gICAgKiBcbiAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICogQG1lbWJlcm9mIFNlcnZpY2VzTWFuYWdlckNvbmZpZ1xuICAgICovXG4gICAgc3RvcE9uSGF2ZVNJR0lOVD86IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiDmmK/lkKblkK/liqjlgaXlurfmo4Dmn6Uo6buY6K6kdHJ1ZSzlkK/liqgpXG4gICAgICogXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICogQG1lbWJlcm9mIFNlcnZpY2VzTWFuYWdlckNvbmZpZ1xuICAgICAqL1xuICAgIHN0YXJ0SGVhbHRoQ2hlY2tpbmc/OiBib29sZWFuO1xufVxuXG4vKipcbiAqIOS/neWtmOazqOWGjOS6hueahOacjeWKoVxuICogXG4gKiBAY2xhc3MgX1NlcnZpY2VzXG4gKi9cbmV4cG9ydCBjbGFzcyBfU2VydmljZXMge1xuICAgIC8qKlxuICAgICAqIOacjeWKoeWunuS+i1xuICAgICAqIFxuICAgICAqIEB0eXBlIHtTZXJ2aWNlTW9kdWxlfVxuICAgICAqIEBtZW1iZXJvZiBfU2VydmljZXNcbiAgICAgKi9cbiAgICByZWFkb25seSBzZXJ2aWNlOiBTZXJ2aWNlTW9kdWxlO1xuXG4gICAgLyoqXG4gICAgICog5pyN5Yqh5piv5ZCm5bey5ZCv5YqoXG4gICAgICogXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICogQG1lbWJlcm9mIF9TZXJ2aWNlc1xuICAgICAqL1xuICAgIGlzU3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICog5pyN5Yqh55qE5ZCN56ew44CC77yI6L+Z6YeM5YaN5L+d5a2Y5LiA5qyh5pyN5Yqh55qE5ZCN56ew5piv5Zug5Li65LiN5YWB6K645pyN5Yqh5ZCN56ew5Zyo6L+Q6KGM6L+H56iL5Lit6KKr5pS55Y+Y77yJXG4gICAgICogXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKiBAbWVtYmVyb2YgX1NlcnZpY2VzXG4gICAgICovXG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICog57uR5a6a5Zyo5pyN5Yqh5LiK55qE6ZSZ6K+v55uR5ZCs5Zmo44CC55So5LqO5LmL5ZCO5Yig6Zmk55uR5ZCs5Zmo5pe25L2/55SoXG4gICAgICogXG4gICAgICogQHR5cGUge0Z1bmN0aW9ufVxuICAgICAqIEBtZW1iZXJvZiBfU2VydmljZXNcbiAgICAgKi9cbiAgICBlcnJvckxpc3RlbmVyOiBGdW5jdGlvbjtcblxuICAgIGNvbnN0cnVjdG9yKHNlcnZpY2U6IFNlcnZpY2VNb2R1bGUpIHtcbiAgICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTtcbiAgICAgICAgdGhpcy5uYW1lID0gc2VydmljZS5uYW1lO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFNlcnZpY2VzTWFuYWdlciBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuXG4gICAgcHJpdmF0ZSBfaXNTdGFydGVkID0gZmFsc2U7ICAgIC8v5piv5ZCm5bey57uP5ZCv5YqoXG4gICAgcHJpdmF0ZSBzdGF0aWMgX3NlcnZpY2VzTWFuYWdlckNyZWF0ZWQgPSBmYWxzZTsgLy9TZXJ2aWNlc01hbmFnZXLmmK/lkKblt7Lnu4/liJvlu7rkuobvvIjkuIDkuKrov5vnqIvlj6rlhYHorrjliJvlu7rkuIDkuKpTZXJ2aWNlc01hbmFnZXLvvIlcblxuICAgIC8qKlxuICAgICAqIOazqOWGjOeahOacjeWKoeOAgijmnI3liqHlj6rlupTlvZPpgJrov4dyZWdpc3RlclNlcnZpY2XmnaXov5vooYzms6jlhowpXG4gICAgICovXG4gICAgcmVhZG9ubHkgX3NlcnZpY2VzOiBfU2VydmljZXNbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBTZXJ2aWNlc01hbmFnZXJDb25maWcgPSB7fSkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIGlmIChTZXJ2aWNlc01hbmFnZXIuX3NlcnZpY2VzTWFuYWdlckNyZWF0ZWQpIHRocm93IG5ldyBFcnJvcignU2VydmljZXNNYW5hZ2Vy5bey57uP6KKr5Yib5bu65LqGJyk7XG4gICAgICAgIFNlcnZpY2VzTWFuYWdlci5fc2VydmljZXNNYW5hZ2VyQ3JlYXRlZCA9IHRydWU7XG5cbiAgICAgICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgIGxvZy5lKCfnqIvluo/lh7rnjrDmnKrmjZXmjYlQcm9taXNl5byC5bi477yaJywgZXJyKTtcblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5zdG9wT25IYXZlVW5oYW5kbGVkUmVqZWN0aW9uICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgICAgICAgbG9nLmUoJ+eoi+W6j+WHuueOsOacquaNleaNieW8guW4uO+8micsIGVycik7XG5cbiAgICAgICAgICAgIGlmIChjb25maWcuc3RvcE9uSGF2ZVVuY2F1Z2h0RXhjZXB0aW9uICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcHJvY2Vzcy5vbignU0lHVEVSTScsICgpID0+IHtcbiAgICAgICAgICAgIGlmIChjb25maWcuc3RvcE9uSGF2ZVNJR1RFUk0gIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IHtcbiAgICAgICAgICAgIGlmIChjb25maWcuc3RvcE9uSGF2ZVNJR0lOVCAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy/phY3nva7lgaXlurfmo4Dmn6XmnI3liqFcbiAgICAgICAgaWYgKGNvbmZpZy5zdGFydEhlYWx0aENoZWNraW5nICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgLy/liKDpmaTkuYvliY3nmoTmjqXlj6PvvIzpgb/lhY3ooqvljaDnlKhcbiAgICAgICAgICAgIGZzLnJlbW92ZVN5bmMoXCIvdG1wL25vZGVfc2VydmljZV9zdGFydGVyL2hlYWx0aF9jaGVja2luZy5zb2NrXCIpO1xuXG4gICAgICAgICAgICBodHRwLmNyZWF0ZVNlcnZlcihhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICAgICAgICAgICAgICAvL2xvZy5sKCfmjqXmlLbliLDlgaXlurfmo4Dmn6Xor7fmsYInKTtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gSGVhbHRoU3RhdHVzLnN1Y2Nlc3M7XG5cbiAgICAgICAgICAgICAgICAvL+ajgOafpeavj+S4gOS4quacjeWKoeeahOWBpeW6t+eKtuWGtVxuICAgICAgICAgICAgICAgIGZvciAobGV0IGl0ZW0gb2YgdGhpcy5fc2VydmljZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgLy/ot7Pov4fmnKrlkK/liqjnmoTmnI3liqFcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpdGVtLmlzU3RhcnRlZCkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IGl0ZW0uc2VydmljZS5vbkhlYWx0aENoZWNraW5nKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdHVzICE9IEhlYWx0aFN0YXR1cy5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLncoaXRlbS5uYW1lLCAn55qE6L+Q6KGM5YGl5bq354q25Ya15Ye6546w5LiN5q2j5bi477yaJywgc3RhdHVzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBzdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2cuZShpdGVtLm5hbWUsICflnKjov5vooYzlgaXlurfmo4Dmn6Xml7blj5HnlJ/lvILluLgnLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJlcy5lbmQocmVzdWx0LnRvU3RyaW5nKCkpO1xuICAgICAgICAgICAgfSkubGlzdGVuKFwiL3RtcC9ub2RlX3NlcnZpY2Vfc3RhcnRlci9oZWFsdGhfY2hlY2tpbmcuc29ja1wiLCAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmUoJ+WBpeW6t+ajgOafpeacjeWKoeWQr+WKqOWksei0pe+8micsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWQr+WKqOaJgOacieazqOWGjOeahOacjeWKoeOAguaMieeFp+azqOWGjOeahOWFiOWQjumhuuW6j+adpeWQr+WKqOacjeWKoeOAguWFiOazqOWGjOeahOacjeWKoeWFiOWQr+WKqOOAgiAgICAgXG4gICAgICog5aaC5p6c5ZCv5Yqo6L+H56iL5Lit5p+Q5Liq5pyN5Yqh5Ye6546w5byC5bi477yM5YiZ5ZCO6Z2i55qE5pyN5Yqh5YiZ5LiN5YaN6KKr5ZCv5Yqo77yM5LmL5YmN5ZCv5Yqo6L+H5LqG55qE5pyN5Yqh5Lmf5Lya6KKr5L6d5qyh5YWz6Zet77yI5oyJ54Wn5LuO5ZCO5ZCR5YmN55qE6aG65bqP77yJ44CCICAgICBcbiAgICAgKiDlkK/liqjnu5PmnZ/lkI7kvJrop6blj5FzdGFydGVk5LqL5Lu2XG4gICAgICogXG4gICAgICogQG1lbWJlcm9mIFNlcnZpY2VzTWFuYWdlclxuICAgICAqL1xuICAgIHN0YXJ0KCkge1xuICAgICAgICBpZiAodGhpcy5faXNTdGFydGVkID09PSBmYWxzZSkge1xuXG4gICAgICAgICAgICBsb2cubCh0aGlzLmNvbnN0cnVjdG9yLm5hbWUsICflvIDlp4vlkK/liqjmnI3liqEnKTtcbiAgICAgICAgICAgIHRoaXMuX2lzU3RhcnRlZCA9IHRydWU7XG5cbiAgICAgICAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaXRlbSBvZiB0aGlzLl9zZXJ2aWNlcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5pc1N0YXJ0ZWQgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5zdGFydGluZygn5byA5aeL5ZCv5Yqo5pyN5YqhJywgaXRlbS5uYW1lKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uaXNTdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBpdGVtLnNlcnZpY2Uub25TdGFydCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8v57uR5a6a6ZSZ6K+v5aSE55CG5ZmoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXJ2aWNlLm9uKCdlcnJvcicsIGl0ZW0uZXJyb3JMaXN0ZW5lcik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuc3RhcnRlZCgn5pyN5Yqh5ZCv5Yqo5oiQ5YqfJywgaXRlbS5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLnN0YXJ0RmFpbGVkKCfmnI3liqHlkK/liqjlpLHotKUnLCBpdGVtLm5hbWUsIGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsb2cubCgn5omA5pyJ5pyN5Yqh5bey5ZCv5YqoJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdzdGFydGVkJyk7XG4gICAgICAgICAgICB9KSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5YWz6Zet5omA5pyJ5bey5ZCv5Yqo55qE5pyN5Yqh44CC5YWI5rOo5YaM55qE5pyN5Yqh5pyA5ZCO6KKr5YWz6Zet44CC5b2T5omA5pyJ5pyN5Yqh6YO96KKr5YWz6Zet5ZCO56iL5bqP5bCG5Lya6KKr6YCA5Ye644CCXG4gICAgICog5b2T5omA5pyJ5pyN5Yqh6YO95YGc5q2i5ZCO5Ye65Y+Rc3RvcHBlZOS6i+S7tlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBleGl0Q29kZSDnqIvluo/pgIDlh7rnirbmgIHnoIHjgIIgMeaYr+acquaNleaNieeahOezu+e7n+mUmeivryAy5piv55So5oi3U2VydmljZU1vZHVsZeeahG9uRXJyb3Llj5Hlh7rnmoTigJhzdG9w4oCZ5L+h5Y+3XG4gICAgICovXG4gICAgc3RvcChleGl0Q29kZSA9IDApIHtcbiAgICAgICAgaWYgKHRoaXMuX2lzU3RhcnRlZCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgbG9nLmwodGhpcy5jb25zdHJ1Y3Rvci5uYW1lLCAn5byA5aeL5YGc5q2i5pyN5YqhJyk7XG4gICAgICAgICAgICB0aGlzLl9pc1N0YXJ0ZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIHRoaXMuX3NlcnZpY2VzLnJldmVyc2UoKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5pc1N0YXJ0ZWQpIHsgICAvL+WPquWFs+mXreW3suWQr+WKqOS6hueahOacjeWKoVxuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuc3RvcHBpbmcoJ+W8gOWni+WBnOatouacjeWKoScsIGl0ZW0ubmFtZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmlzU3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGl0ZW0uc2VydmljZS5vblN0b3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+a4hemZpOe7keWumueahOmUmeivr+ebkeWQrOWZqFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uc2VydmljZS5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBpdGVtLmVycm9yTGlzdGVuZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLnN0b3BwZWQoJ+acjeWKoeWQr+WKqOaIkOWKnycsIGl0ZW0ubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5zdG9wRmFpbGVkKCfmnI3liqHlgZzmraLlpLHotKUnLCBpdGVtLm5hbWUsIGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxvZy5sKCfmiYDmnInmnI3liqHlt7LlgZzmraInKTtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ3N0b3BwZWQnKTtcblxuICAgICAgICAgICAgICAgIC8v6YCA5Ye65pyN5YqhXG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KGV4aXRDb2RlKTtcbiAgICAgICAgICAgIH0pKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDms6jlhozmnI3liqFcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1NlcnZpY2VNb2R1bGV9IHNlcnZpY2VNb2R1bGUg5pyN5Yqh5qih5Z2X5a6e5L6LXG4gICAgICogQG1lbWJlcm9mIFNlcnZpY2VzTWFuYWdlclxuICAgICAqL1xuICAgIHJlZ2lzdGVyU2VydmljZShzZXJ2aWNlTW9kdWxlOiBTZXJ2aWNlTW9kdWxlKSB7XG4gICAgICAgIGlmICh0aGlzLl9zZXJ2aWNlcy5zb21lKGl0ZW0gPT4gaXRlbS5uYW1lID09IHNlcnZpY2VNb2R1bGUubmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5pyN5YqhJyR7c2VydmljZU1vZHVsZS5uYW1lfSflt7Lms6jlhozov4fkuoZgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHNlcnZpY2UgPSBuZXcgX1NlcnZpY2VzKHNlcnZpY2VNb2R1bGUpO1xuXG4gICAgICAgICAgICAvL+WIm+W7uuacjeWKoei/kOihjOaXtumUmeivr+ebkeWQrOWZqFxuICAgICAgICAgICAgc2VydmljZS5lcnJvckxpc3RlbmVyID0gKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHNlcnZpY2Uuc2VydmljZS5vbkVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIGZhbHNlOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVyciwgc2VydmljZU1vZHVsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSB0cnVlOlxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3N0b3AnOlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVyciwgc2VydmljZU1vZHVsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoMik7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcih2YWx1ZSwgc2VydmljZU1vZHVsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLl9zZXJ2aWNlcy5wdXNoKHNlcnZpY2UpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5pyN5Yqh6L+Q6KGM6L+H56iL5Lit55qE6ZSZ6K+v5aSE55CG5pa55rOV44CC5pyN5Yqh5ZCv5Yqo5oiW5YWz6Zet6L+H56iL5Lit5Lqn55Sf55qE6ZSZ6K+v5LiN5Lya6Kem5Y+R6K+l5pa55rOV44CCXG4gICAgICogXG4gICAgICogQHBhcmFtIHtFcnJvcn0gZXJyIFxuICAgICAqIEBwYXJhbSB7U2VydmljZU1vZHVsZX0gc2VydmljZSDlj5HnlJ/plJnor6/nmoTmnI3liqHlrp7kvotcbiAgICAgKiBAbWVtYmVyb2YgU2VydmljZXNNYW5hZ2VyXG4gICAgICovXG4gICAgb25FcnJvcihlcnI6IEVycm9yLCBzZXJ2aWNlOiBTZXJ2aWNlTW9kdWxlKSB7XG4gICAgICAgIGxvZy5lKHNlcnZpY2UubmFtZSwgJ+WPkeeUn+mUmeivr++8micsIGVycik7XG4gICAgfVxufSJdfQ==
