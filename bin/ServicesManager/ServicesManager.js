"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events = require("events");
const http = require("http");
const fs = require("fs-extra");
const RegisteredService_1 = require("../RegisteredService/RegisteredService");
const Log_1 = require("../Log");
const RunningStatus_1 = require("../RunningStatus");
/**
 * 服务管理器
 *
 * @export
 * @class ServicesManager
 * @extends {events.EventEmitter}
 */
class ServicesManager extends events.EventEmitter {
    constructor(_config = {}) {
        super();
        this._config = _config;
        this._status = RunningStatus_1.RunningStatus.stopped;
        /**
         * 注册的服务列表。(服务只应当通过registerService来进行注册)
         *
         * key是服务名称
         */
        this.services = new Map();
        if (ServicesManager._servicesManagerCreated)
            throw new Error(`${this.name}已经被创建了`);
        ServicesManager._servicesManagerCreated = true;
        process.on('unhandledRejection', (err) => {
            Log_1.log.s1.e('程序', '出现未捕捉Promise异常：', err);
            if (_config.stopOnHaveUnhandledRejection !== false) {
                //确保不会重复关闭
                if (this._status !== RunningStatus_1.RunningStatus.stopping) {
                    //如果服务还未启动过
                    if (this._status === RunningStatus_1.RunningStatus.stopped) {
                        process.exit(1);
                    }
                    else {
                        this.stop(1);
                    }
                }
            }
        });
        process.on('uncaughtException', (err) => {
            Log_1.log.s1.e('程序', '出现未捕捉异常：', err);
            if (_config.stopOnHaveUncaughtException !== false) {
                if (this._status !== RunningStatus_1.RunningStatus.stopping) {
                    if (this._status === RunningStatus_1.RunningStatus.stopped) {
                        process.exit(1);
                    }
                    else {
                        this.stop(1);
                    }
                }
            }
        });
        let forceClose = false; //用于标记是否强制退出程序
        const signalClose = () => {
            if (this._status !== RunningStatus_1.RunningStatus.stopping) {
                if (this._status === RunningStatus_1.RunningStatus.stopped) {
                    process.exit();
                }
                else {
                    this.stop();
                }
            }
            else {
                if (forceClose === false) {
                    console.log('正在停止程序，请稍后。。。', Log_1.log.chalk.gray('（如果要强制退出，请在3秒钟之内再次点击）'));
                    forceClose = true;
                    setTimeout(function () {
                        forceClose = false;
                    }, 3000);
                }
                else {
                    process.exit();
                }
            }
        };
        process.on('SIGTERM', () => {
            if (_config.stopOnHaveSIGTERM !== false) {
                signalClose();
            }
        });
        process.on('SIGINT', () => {
            if (_config.stopOnHaveSIGINT !== false) {
                signalClose();
            }
        });
        //配置健康检查服务
        if (_config.startHealthChecking !== false) {
            //要被监听的端口
            const port = "/tmp/service_starter_health_checking.sock";
            //删除之前的端口，避免被占用
            fs.removeSync(port);
            http.createServer(async (req, res) => {
                if (this._status !== RunningStatus_1.RunningStatus.running) {
                    //服务还未处于running时直接返回当前的状态名称
                    return res.end(RunningStatus_1.RunningStatus[this._status]);
                }
                else {
                    let result;
                    //检查每一个服务的健康状况
                    for (let item of this.services.values()) {
                        const err = await item._healthCheck();
                        //不为空就表示有问题了
                        if (err !== undefined) {
                            result = [err, item];
                            break;
                        }
                    }
                    if (result === undefined) {
                        res.end(RunningStatus_1.RunningStatus[this._status]);
                    }
                    else {
                        res.end(`[${result[1].service.name}]  ${result[0]}`);
                    }
                }
            }).listen(port, (err) => {
                if (err) {
                    Log_1.log.s1.e('ServicesManager', '健康检查服务器启动失败：', err);
                    process.exit(1);
                }
            });
        }
    }
    /**
     * 运行状态
     */
    get status() {
        return this._status;
    }
    /**
     * ServicesManager 的名称，默认是类名。
     */
    get name() {
        return this.constructor.name;
    }
    /**
     * 启动所有注册的服务。按照注册的先后顺序来启动服务。先注册的服务先启动。
     * 如果启动过程中某个服务出现异常，则后面的服务则不再被启动，之前启动过了的服务也会被依次关闭（按照从后向前的顺序）。
     * 启动结束后会触发started事件
     */
    start() {
        //主要是为了等待构造函数中的事件绑定完成
        setImmediate(this._start.bind(this));
    }
    async _start() {
        //确保只有在stopped的情况下才能执行start
        if (this._status !== RunningStatus_1.RunningStatus.stopped) {
            throw new Error(Log_1.log.s1.format(`服务管理器：${this.name}`, '在还未完全关闭的情况下又再次被启动。', `当前的状态为：${RunningStatus_1.RunningStatus[this._status]}`));
        }
        Log_1.log.s1.l(Log_1.log.chalk.bold.bgMagenta(this.name), '开始启动服务');
        this._status = RunningStatus_1.RunningStatus.starting;
        for (let item of this.services.values()) {
            //如果启动过程中出现了异常则就不再向下启动了（因为出现了异常之后_status或变为stopping）
            if (this._status !== RunningStatus_1.RunningStatus.starting)
                return;
            const failed = await item._start();
            //不为空则表示启动失败
            if (failed !== undefined) {
                return this.stop(2);
            }
        }
        Log_1.log.s1.l(Log_1.log.chalk.bold.bgMagenta(this.name), '所有服务已启动');
        this._status = RunningStatus_1.RunningStatus.running;
        this.emit('started');
    }
    /**
     * 关闭所有已启动的服务。先注册的服务最后被关闭。当所有服务都被关闭后将会退出程序。
     * 当所有服务都停止后出发stopped事件
     *
     * @param exitCode 程序退出状态码。 1是系统错误  2用户服务错误
     */
    stop(exitCode = 0) {
        setImmediate(this._stop.bind(this), exitCode);
    }
    async _stop(exitCode) {
        //确保不会重复停止
        if (this._status === RunningStatus_1.RunningStatus.stopping || this._status === RunningStatus_1.RunningStatus.stopped) {
            throw new Error(Log_1.log.s1.format(`服务管理器：${this.name}`, '在处于正在停止或已停止的状态下又再次被停止。', `当前的状态为：${RunningStatus_1.RunningStatus[this._status]}`));
        }
        Log_1.log.s1.l(Log_1.log.chalk.bold.bgMagenta(this.name), '开始停止服务');
        this._status = RunningStatus_1.RunningStatus.stopping;
        for (let item of Array.from(this.services.values()).reverse()) {
            if (item.status !== RunningStatus_1.RunningStatus.stopping && item.status !== RunningStatus_1.RunningStatus.stopped)
                await item._stop();
        }
        Log_1.log.s1.l(Log_1.log.chalk.bold.bgMagenta(this.name), '所有服务已停止');
        this._status = RunningStatus_1.RunningStatus.stopped;
        this.emit('stopped');
        //是否退出服务
        if (this._config.exitAfterStopped !== false)
            process.exit(exitCode);
    }
    /**
     * 注册服务。注册服务的名称是以类名为准
     *
     * @param {ServiceModule} serviceModule 服务模块实例
     * @memberof ServicesManager
     */
    registerService(serviceModule) {
        if (this.services.has(serviceModule.constructor.name)) {
            throw new Error(`服务：'${serviceModule.name}'已注册过了`);
        }
        else {
            this.services.set(serviceModule.constructor.name, new RegisteredService_1.RegisteredService(serviceModule, this));
        }
    }
    /**
     * 服务运行过程中的错误处理方法。服务启动或关闭过程中产生的错误不会触发该方法。
     * 注意：onError中的代码不应出现错误，如果onError的中的代码出现错误将直接导致程序关闭。
     *
     * @param {Error} err
     * @param {ServiceModule} service 发生错误的服务实例
     * @memberof ServicesManager
     */
    onError(err, service) {
        Log_1.log.s1.e(`服务：${service.name}`, '发生错误：', err);
    }
}
//ServicesManager是否已经创建了（一个容器只允许创建一个ServicesManager）
ServicesManager._servicesManagerCreated = false;
exports.ServicesManager = ServicesManager;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNlcnZpY2VzTWFuYWdlci9TZXJ2aWNlc01hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBa0M7QUFDbEMsNkJBQThCO0FBQzlCLCtCQUFnQztBQUVoQyw4RUFBMkU7QUFDM0UsZ0NBQTZCO0FBRzdCLG9EQUFpRDtBQUVqRDs7Ozs7O0dBTUc7QUFDSCxxQkFBNkIsU0FBUSxNQUFNLENBQUMsWUFBWTtJQTJCcEQsWUFBNkIsVUFBaUMsRUFBRTtRQUM1RCxLQUFLLEVBQUUsQ0FBQztRQURpQixZQUFPLEdBQVAsT0FBTyxDQUE0QjtRQWhCeEQsWUFBTyxHQUFrQiw2QkFBYSxDQUFDLE9BQU8sQ0FBQztRQVN2RDs7OztXQUlHO1FBQ00sYUFBUSxHQUFHLElBQUksR0FBRyxFQUE2QixDQUFBO1FBS3BELEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQztZQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxRQUFRLENBQUMsQ0FBQztRQUNuRixlQUFlLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDO1FBRS9DLE9BQU8sQ0FBQyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxHQUFVO1lBQ3hDLFNBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUV2QyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsNEJBQTRCLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDakQsVUFBVTtnQkFDVixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLDZCQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztvQkFDMUMsV0FBVztvQkFDWCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLDZCQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFDekMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENB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ZUFBZSxDQUFDLGFBQTRCO1FBQ3hDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BELE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxhQUFhLENBQUMsSUFBSSxRQUFRLENBQUMsQ0FBQztRQUN2RCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLHFDQUFpQixDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2xHLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILE9BQU8sQ0FBQyxHQUFVLEVBQUUsT0FBc0I7UUFDdEMsU0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELENBQUM7O0FBOU9ELG9EQUFvRDtBQUNyQyx1Q0FBdUIsR0FBRyxLQUFLLENBQUM7QUFIbkQsMENBaVBDIiwiZmlsZSI6IlNlcnZpY2VzTWFuYWdlci9TZXJ2aWNlc01hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXZlbnRzID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5pbXBvcnQgaHR0cCA9IHJlcXVpcmUoJ2h0dHAnKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5cbmltcG9ydCB7IFJlZ2lzdGVyZWRTZXJ2aWNlIH0gZnJvbSAnLi4vUmVnaXN0ZXJlZFNlcnZpY2UvUmVnaXN0ZXJlZFNlcnZpY2UnO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vTG9nJztcbmltcG9ydCB7IFNlcnZpY2VNb2R1bGUgfSBmcm9tIFwiLi4vU2VydmljZU1vZHVsZS9TZXJ2aWNlTW9kdWxlXCI7XG5pbXBvcnQgeyBTZXJ2aWNlc01hbmFnZXJDb25maWcgfSBmcm9tIFwiLi9TZXJ2aWNlc01hbmFnZXJDb25maWdcIjtcbmltcG9ydCB7IFJ1bm5pbmdTdGF0dXMgfSBmcm9tIFwiLi4vUnVubmluZ1N0YXR1c1wiO1xuXG4vKipcbiAqIOacjeWKoeeuoeeQhuWZqFxuICogXG4gKiBAZXhwb3J0XG4gKiBAY2xhc3MgU2VydmljZXNNYW5hZ2VyXG4gKiBAZXh0ZW5kcyB7ZXZlbnRzLkV2ZW50RW1pdHRlcn1cbiAqL1xuZXhwb3J0IGNsYXNzIFNlcnZpY2VzTWFuYWdlciBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuXG4gICAgLy9TZXJ2aWNlc01hbmFnZXLmmK/lkKblt7Lnu4/liJvlu7rkuobvvIjkuIDkuKrlrrnlmajlj6rlhYHorrjliJvlu7rkuIDkuKpTZXJ2aWNlc01hbmFnZXLvvIlcbiAgICBwcml2YXRlIHN0YXRpYyBfc2VydmljZXNNYW5hZ2VyQ3JlYXRlZCA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICog6L+Q6KGM54q25oCBXG4gICAgICovXG4gICAgZ2V0IHN0YXR1cygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXR1cztcbiAgICB9XG4gICAgcHJpdmF0ZSBfc3RhdHVzOiBSdW5uaW5nU3RhdHVzID0gUnVubmluZ1N0YXR1cy5zdG9wcGVkO1xuXG4gICAgLyoqXG4gICAgICogU2VydmljZXNNYW5hZ2VyIOeahOWQjeensO+8jOm7mOiupOaYr+exu+WQjeOAglxuICAgICAqL1xuICAgIGdldCBuYW1lKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLm5hbWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5rOo5YaM55qE5pyN5Yqh5YiX6KGo44CCKOacjeWKoeWPquW6lOW9k+mAmui/h3JlZ2lzdGVyU2VydmljZeadpei/m+ihjOazqOWGjClcbiAgICAgKiBcbiAgICAgKiBrZXnmmK/mnI3liqHlkI3np7BcbiAgICAgKi9cbiAgICByZWFkb25seSBzZXJ2aWNlcyA9IG5ldyBNYXA8c3RyaW5nLCBSZWdpc3RlcmVkU2VydmljZT4oKVxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfY29uZmlnOiBTZXJ2aWNlc01hbmFnZXJDb25maWcgPSB7fSkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIGlmIChTZXJ2aWNlc01hbmFnZXIuX3NlcnZpY2VzTWFuYWdlckNyZWF0ZWQpIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLm5hbWV95bey57uP6KKr5Yib5bu65LqGYCk7XG4gICAgICAgIFNlcnZpY2VzTWFuYWdlci5fc2VydmljZXNNYW5hZ2VyQ3JlYXRlZCA9IHRydWU7XG5cbiAgICAgICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKGVycjogRXJyb3IpID0+IHtcbiAgICAgICAgICAgIGxvZy5zMS5lKCfnqIvluo8nLCAn5Ye6546w5pyq5o2V5o2JUHJvbWlzZeW8guW4uO+8micsIGVycik7XG5cbiAgICAgICAgICAgIGlmIChfY29uZmlnLnN0b3BPbkhhdmVVbmhhbmRsZWRSZWplY3Rpb24gIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgLy/noa7kv53kuI3kvJrph43lpI3lhbPpl61cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBSdW5uaW5nU3RhdHVzLnN0b3BwaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIC8v5aaC5p6c5pyN5Yqh6L+Y5pyq5ZCv5Yqo6L+HXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zdGF0dXMgPT09IFJ1bm5pbmdTdGF0dXMuc3RvcHBlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnI6IEVycm9yKSA9PiB7XG4gICAgICAgICAgICBsb2cuczEuZSgn56iL5bqPJywgJ+WHuueOsOacquaNleaNieW8guW4uO+8micsIGVycik7XG5cbiAgICAgICAgICAgIGlmIChfY29uZmlnLnN0b3BPbkhhdmVVbmNhdWdodEV4Y2VwdGlvbiAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBSdW5uaW5nU3RhdHVzLnN0b3BwaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zdGF0dXMgPT09IFJ1bm5pbmdTdGF0dXMuc3RvcHBlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgZm9yY2VDbG9zZSA9IGZhbHNlOyAgICAgLy/nlKjkuo7moIforrDmmK/lkKblvLrliLbpgIDlh7rnqIvluo9cbiAgICAgICAgY29uc3Qgc2lnbmFsQ2xvc2UgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBSdW5uaW5nU3RhdHVzLnN0b3BwaW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXR1cyA9PT0gUnVubmluZ1N0YXR1cy5zdG9wcGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGZvcmNlQ2xvc2UgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfmraPlnKjlgZzmraLnqIvluo/vvIzor7fnqI3lkI7jgILjgILjgIInLCBsb2cuY2hhbGsuZ3JheSgn77yI5aaC5p6c6KaB5by65Yi26YCA5Ye677yM6K+35ZyoM+enkumSn+S5i+WGheWGjeasoeeCueWHu++8iScpKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yY2VDbG9zZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VDbG9zZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9LCAzMDAwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgcHJvY2Vzcy5vbignU0lHVEVSTScsICgpID0+IHtcbiAgICAgICAgICAgIGlmIChfY29uZmlnLnN0b3BPbkhhdmVTSUdURVJNICE9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHNpZ25hbENsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IHtcbiAgICAgICAgICAgIGlmIChfY29uZmlnLnN0b3BPbkhhdmVTSUdJTlQgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgc2lnbmFsQ2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy/phY3nva7lgaXlurfmo4Dmn6XmnI3liqFcbiAgICAgICAgaWYgKF9jb25maWcuc3RhcnRIZWFsdGhDaGVja2luZyAhPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIC8v6KaB6KKr55uR5ZCs55qE56uv5Y+jXG4gICAgICAgICAgICBjb25zdCBwb3J0ID0gXCIvdG1wL3NlcnZpY2Vfc3RhcnRlcl9oZWFsdGhfY2hlY2tpbmcuc29ja1wiO1xuXG4gICAgICAgICAgICAvL+WIoOmZpOS5i+WJjeeahOerr+WPo++8jOmBv+WFjeiiq+WNoOeUqFxuICAgICAgICAgICAgZnMucmVtb3ZlU3luYyhwb3J0KTtcblxuICAgICAgICAgICAgaHR0cC5jcmVhdGVTZXJ2ZXIoYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXR1cyAhPT0gUnVubmluZ1N0YXR1cy5ydW5uaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIC8v5pyN5Yqh6L+Y5pyq5aSE5LqOcnVubmluZ+aXtuebtOaOpei/lOWbnuW9k+WJjeeahOeKtuaAgeWQjeensFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmVuZChSdW5uaW5nU3RhdHVzW3RoaXMuX3N0YXR1c10pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQ6IFtFcnJvciwgUmVnaXN0ZXJlZFNlcnZpY2VdIHwgdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICAgICAgICAgIC8v5qOA5p+l5q+P5LiA5Liq5pyN5Yqh55qE5YGl5bq354q25Ya1XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGl0ZW0gb2YgdGhpcy5zZXJ2aWNlcy52YWx1ZXMoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyID0gYXdhaXQgaXRlbS5faGVhbHRoQ2hlY2soKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgLy/kuI3kuLrnqbrlsLHooajnpLrmnInpl67popjkuoZcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IFtlcnIsIGl0ZW1dO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuZW5kKFJ1bm5pbmdTdGF0dXNbdGhpcy5fc3RhdHVzXSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXMuZW5kKGBbJHtyZXN1bHRbMV0uc2VydmljZS5uYW1lfV0gICR7cmVzdWx0WzBdfWApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkubGlzdGVuKHBvcnQsIChlcnI6IEVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBsb2cuczEuZSgnU2VydmljZXNNYW5hZ2VyJywgJ+WBpeW6t+ajgOafpeacjeWKoeWZqOWQr+WKqOWksei0pe+8micsIGVycik7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWQr+WKqOaJgOacieazqOWGjOeahOacjeWKoeOAguaMieeFp+azqOWGjOeahOWFiOWQjumhuuW6j+adpeWQr+WKqOacjeWKoeOAguWFiOazqOWGjOeahOacjeWKoeWFiOWQr+WKqOOAgiAgICAgXG4gICAgICog5aaC5p6c5ZCv5Yqo6L+H56iL5Lit5p+Q5Liq5pyN5Yqh5Ye6546w5byC5bi477yM5YiZ5ZCO6Z2i55qE5pyN5Yqh5YiZ5LiN5YaN6KKr5ZCv5Yqo77yM5LmL5YmN5ZCv5Yqo6L+H5LqG55qE5pyN5Yqh5Lmf5Lya6KKr5L6d5qyh5YWz6Zet77yI5oyJ54Wn5LuO5ZCO5ZCR5YmN55qE6aG65bqP77yJ44CCICAgICBcbiAgICAgKiDlkK/liqjnu5PmnZ/lkI7kvJrop6blj5FzdGFydGVk5LqL5Lu2XG4gICAgICovXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIC8v5Li76KaB5piv5Li65LqG562J5b6F5p6E6YCg5Ye95pWw5Lit55qE5LqL5Lu257uR5a6a5a6M5oiQXG4gICAgICAgIHNldEltbWVkaWF0ZSh0aGlzLl9zdGFydC5iaW5kKHRoaXMpKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBhc3luYyBfc3RhcnQoKSB7XG4gICAgICAgIC8v56Gu5L+d5Y+q5pyJ5Zyoc3RvcHBlZOeahOaDheWGteS4i+aJjeiDveaJp+ihjHN0YXJ0XG4gICAgICAgIGlmICh0aGlzLl9zdGF0dXMgIT09IFJ1bm5pbmdTdGF0dXMuc3RvcHBlZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIGxvZy5zMS5mb3JtYXQoXG4gICAgICAgICAgICAgICAgICAgIGDmnI3liqHnrqHnkIblmajvvJoke3RoaXMubmFtZX1gLFxuICAgICAgICAgICAgICAgICAgICAn5Zyo6L+Y5pyq5a6M5YWo5YWz6Zet55qE5oOF5Ya15LiL5Y+I5YaN5qyh6KKr5ZCv5Yqo44CCJyxcbiAgICAgICAgICAgICAgICAgICAgYOW9k+WJjeeahOeKtuaAgeS4uu+8miR7UnVubmluZ1N0YXR1c1t0aGlzLl9zdGF0dXNdfWBcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nLnMxLmwobG9nLmNoYWxrLmJvbGQuYmdNYWdlbnRhKHRoaXMubmFtZSksICflvIDlp4vlkK/liqjmnI3liqEnKTtcbiAgICAgICAgdGhpcy5fc3RhdHVzID0gUnVubmluZ1N0YXR1cy5zdGFydGluZztcblxuICAgICAgICBmb3IgKGxldCBpdGVtIG9mIHRoaXMuc2VydmljZXMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgIC8v5aaC5p6c5ZCv5Yqo6L+H56iL5Lit5Ye6546w5LqG5byC5bi45YiZ5bCx5LiN5YaN5ZCR5LiL5ZCv5Yqo5LqG77yI5Zug5Li65Ye6546w5LqG5byC5bi45LmL5ZCOX3N0YXR1c+aIluWPmOS4unN0b3BwaW5n77yJXG4gICAgICAgICAgICBpZiAodGhpcy5fc3RhdHVzICE9PSBSdW5uaW5nU3RhdHVzLnN0YXJ0aW5nKSByZXR1cm47XG5cbiAgICAgICAgICAgIGNvbnN0IGZhaWxlZCA9IGF3YWl0IGl0ZW0uX3N0YXJ0KCk7XG5cbiAgICAgICAgICAgIC8v5LiN5Li656m65YiZ6KGo56S65ZCv5Yqo5aSx6LSlXG4gICAgICAgICAgICBpZiAoZmFpbGVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdG9wKDIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbG9nLnMxLmwobG9nLmNoYWxrLmJvbGQuYmdNYWdlbnRhKHRoaXMubmFtZSksICfmiYDmnInmnI3liqHlt7LlkK/liqgnKTtcbiAgICAgICAgdGhpcy5fc3RhdHVzID0gUnVubmluZ1N0YXR1cy5ydW5uaW5nO1xuICAgICAgICB0aGlzLmVtaXQoJ3N0YXJ0ZWQnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlhbPpl63miYDmnInlt7LlkK/liqjnmoTmnI3liqHjgILlhYjms6jlhoznmoTmnI3liqHmnIDlkI7ooqvlhbPpl63jgILlvZPmiYDmnInmnI3liqHpg73ooqvlhbPpl63lkI7lsIbkvJrpgIDlh7rnqIvluo/jgIJcbiAgICAgKiDlvZPmiYDmnInmnI3liqHpg73lgZzmraLlkI7lh7rlj5FzdG9wcGVk5LqL5Lu2XG4gICAgICogXG4gICAgICogQHBhcmFtIGV4aXRDb2RlIOeoi+W6j+mAgOWHuueKtuaAgeeggeOAgiAx5piv57O757uf6ZSZ6K+vICAy55So5oi35pyN5Yqh6ZSZ6K+vXG4gICAgICovXG4gICAgc3RvcChleGl0Q29kZSA9IDApIHtcbiAgICAgICAgc2V0SW1tZWRpYXRlKHRoaXMuX3N0b3AuYmluZCh0aGlzKSwgZXhpdENvZGUpO1xuICAgIH1cbiAgICBwcml2YXRlIGFzeW5jIF9zdG9wKGV4aXRDb2RlOiBudW1iZXIpIHtcbiAgICAgICAgLy/noa7kv53kuI3kvJrph43lpI3lgZzmraJcbiAgICAgICAgaWYgKHRoaXMuX3N0YXR1cyA9PT0gUnVubmluZ1N0YXR1cy5zdG9wcGluZyB8fCB0aGlzLl9zdGF0dXMgPT09IFJ1bm5pbmdTdGF0dXMuc3RvcHBlZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIGxvZy5zMS5mb3JtYXQoXG4gICAgICAgICAgICAgICAgICAgIGDmnI3liqHnrqHnkIblmajvvJoke3RoaXMubmFtZX1gLFxuICAgICAgICAgICAgICAgICAgICAn5Zyo5aSE5LqO5q2j5Zyo5YGc5q2i5oiW5bey5YGc5q2i55qE54q25oCB5LiL5Y+I5YaN5qyh6KKr5YGc5q2i44CCJyxcbiAgICAgICAgICAgICAgICAgICAgYOW9k+WJjeeahOeKtuaAgeS4uu+8miR7UnVubmluZ1N0YXR1c1t0aGlzLl9zdGF0dXNdfWBcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nLnMxLmwobG9nLmNoYWxrLmJvbGQuYmdNYWdlbnRhKHRoaXMubmFtZSksICflvIDlp4vlgZzmraLmnI3liqEnKTtcbiAgICAgICAgdGhpcy5fc3RhdHVzID0gUnVubmluZ1N0YXR1cy5zdG9wcGluZztcblxuICAgICAgICBmb3IgKGxldCBpdGVtIG9mIEFycmF5LmZyb20odGhpcy5zZXJ2aWNlcy52YWx1ZXMoKSkucmV2ZXJzZSgpKSB7XG4gICAgICAgICAgICBpZiAoaXRlbS5zdGF0dXMgIT09IFJ1bm5pbmdTdGF0dXMuc3RvcHBpbmcgJiYgaXRlbS5zdGF0dXMgIT09IFJ1bm5pbmdTdGF0dXMuc3RvcHBlZClcbiAgICAgICAgICAgICAgICBhd2FpdCBpdGVtLl9zdG9wKCk7XG4gICAgICAgIH1cblxuICAgICAgICBsb2cuczEubChsb2cuY2hhbGsuYm9sZC5iZ01hZ2VudGEodGhpcy5uYW1lKSwgJ+aJgOacieacjeWKoeW3suWBnOatoicpO1xuICAgICAgICB0aGlzLl9zdGF0dXMgPSBSdW5uaW5nU3RhdHVzLnN0b3BwZWQ7XG4gICAgICAgIHRoaXMuZW1pdCgnc3RvcHBlZCcpO1xuXG4gICAgICAgIC8v5piv5ZCm6YCA5Ye65pyN5YqhXG4gICAgICAgIGlmICh0aGlzLl9jb25maWcuZXhpdEFmdGVyU3RvcHBlZCAhPT0gZmFsc2UpXG4gICAgICAgICAgICBwcm9jZXNzLmV4aXQoZXhpdENvZGUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOazqOWGjOacjeWKoeOAguazqOWGjOacjeWKoeeahOWQjeensOaYr+S7peexu+WQjeS4uuWHhlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7U2VydmljZU1vZHVsZX0gc2VydmljZU1vZHVsZSDmnI3liqHmqKHlnZflrp7kvotcbiAgICAgKiBAbWVtYmVyb2YgU2VydmljZXNNYW5hZ2VyXG4gICAgICovXG4gICAgcmVnaXN0ZXJTZXJ2aWNlKHNlcnZpY2VNb2R1bGU6IFNlcnZpY2VNb2R1bGUpIHtcbiAgICAgICAgaWYgKHRoaXMuc2VydmljZXMuaGFzKHNlcnZpY2VNb2R1bGUuY29uc3RydWN0b3IubmFtZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5pyN5Yqh77yaJyR7c2VydmljZU1vZHVsZS5uYW1lfSflt7Lms6jlhozov4fkuoZgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2VydmljZXMuc2V0KHNlcnZpY2VNb2R1bGUuY29uc3RydWN0b3IubmFtZSwgbmV3IFJlZ2lzdGVyZWRTZXJ2aWNlKHNlcnZpY2VNb2R1bGUsIHRoaXMpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOacjeWKoei/kOihjOi/h+eoi+S4reeahOmUmeivr+WkhOeQhuaWueazleOAguacjeWKoeWQr+WKqOaIluWFs+mXrei/h+eoi+S4reS6p+eUn+eahOmUmeivr+S4jeS8muinpuWPkeivpeaWueazleOAglxuICAgICAqIOazqOaEj++8mm9uRXJyb3LkuK3nmoTku6PnoIHkuI3lupTlh7rnjrDplJnor6/vvIzlpoLmnpxvbkVycm9y55qE5Lit55qE5Luj56CB5Ye6546w6ZSZ6K+v5bCG55u05o6l5a+86Ie056iL5bqP5YWz6Zet44CCXG4gICAgICogXG4gICAgICogQHBhcmFtIHtFcnJvcn0gZXJyIFxuICAgICAqIEBwYXJhbSB7U2VydmljZU1vZHVsZX0gc2VydmljZSDlj5HnlJ/plJnor6/nmoTmnI3liqHlrp7kvotcbiAgICAgKiBAbWVtYmVyb2YgU2VydmljZXNNYW5hZ2VyXG4gICAgICovXG4gICAgb25FcnJvcihlcnI6IEVycm9yLCBzZXJ2aWNlOiBTZXJ2aWNlTW9kdWxlKSB7XG4gICAgICAgIGxvZy5zMS5lKGDmnI3liqHvvJoke3NlcnZpY2UubmFtZX1gLCAn5Y+R55Sf6ZSZ6K+v77yaJywgZXJyKTtcbiAgICB9XG59Il19
